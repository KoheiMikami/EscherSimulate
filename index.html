<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>EscherSimulator</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    h1 {
      width: 960px;
      margin: 0 auto;
      margin-top: 20px;
      margin-bottom: 30px;
    }

    #stage {
      width: 960px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <h1>EscherSimulate</h1>
  <div id="stage"></div>
  <script src="three.min.js"></script>
  <script src="perlin-noise-simplex.js"></script>

  <script>
    Rect = function() {
      this.root = new THREE.Object3D();
      this.rectWidth = 300;
      this.rectHeight = 300;
    };
    Rect.prototype.degToRad = function(deg) {
      return deg * Math.PI / 180;
    };
    Rect.prototype.createLine = function(rotationZ, translateX, translateY) {
      var simplexNoise = new SimplexNoise;
      var curve = new THREE.CubicBezierCurve3(
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(100, 0, 0),
        new THREE.Vector3(200, 0, 0),
        new THREE.Vector3(this.rectWidth, 0, 0)
      );

      var curveObject = new THREE.Line((function() {
        var geometry = new THREE.Geometry();
        geometry.vertices = curve.getPoints(5);
        return geometry;
      })(), new THREE.LineBasicMaterial({
        color: 0xffffff
      }));

      curveObject.rotation.z = this.degToRad(rotationZ);
      curveObject.translateX(translateX);
      curveObject.translateY(translateY);
      this.root.add(curveObject);
    };
    Rect.prototype.addRect = function(x, y) {
      this.createLine(0, 0, 0);
      this.createLine(-90, 0, 300);
      this.createLine(0, 0, -300);
      this.createLine(-90, 0, 0);
      this.root.translateX(x);
      this.root.translateY(y);
      this.root.scale.set(0.1, 0.1, 0.1);
      console.log(this.root);
      return this.root;
    };
    Rect.prototype.addAnimate = function(num) {
      this.root.children[0].geometry.verticesNeedUpdate = true
      var simplexNoise = new SimplexNoise;
      for (i = 0; i < this.root.children[0].geometry.vertices.length; i++) {
        var vertex = this.root.children[0].geometry.vertices[i];

        //vertex.y = simplexNoise.noise(vertex.x / 20, vertex.y / 20)*100;
        vertex.y = num[i];
      }
    };

    (function() {
      var width = 960;
      var height = 540;
      var light;
      var camera;
      var ambient;
      var axis;
      var scene = new THREE.Scene();
      var displayObj = [];
      camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
      camera.position.set(0, 0, 800);
      camera.lookAt(new THREE.Vector3(0, 0, 0));

      light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 100, 30);
      scene.add(light);
      ambient = new THREE.AmbientLight(0x550000);
      scene.add(ambient);

      axis = new THREE.AxisHelper(1500);
      axis.position.set(0, 0, 0);
      scene.add(axis);

      for (var i = 0; i < 10; i++) {
        for (var k = 0; k < 10; k++) {
          var rect = new Rect();
          displayObj.push(rect);
          scene.add(rect.addRect(k * 30 - 150, i * 30 - 120));
        }
      }

      setInterval(function() {
        var simplexNoise = new SimplexNoise;
        var num = [];
        for (var i = 0; i < displayObj[0].root.children[0].geometry.vertices.length; i++) {
          var vertex = displayObj[0].root.children[0].geometry.vertices[i];
          num.push(simplexNoise.noise(vertex.x / 20, vertex.y / 20) * 100);
        }

        for (var i = 0; i < displayObj.length; i++) {
          displayObj[i].addAnimate(num);
        }
        //displayObj[0].addAnimate(num);
      }, 1000);

      //rendering
      var renderer = new THREE.WebGLRenderer();
      renderer.setSize(width, height);
      renderer.setClearColor(0x000000, 1);
      document.getElementById('stage').appendChild(renderer.domElement);

      var render = function() {
        requestAnimationFrame(render);
        renderer.render(scene, camera);
      };
      render();

    })();
  </script>

</body>

</html>
