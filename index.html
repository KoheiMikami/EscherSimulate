<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>EscherSimulator</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    h1 {
      width: 960px;
      margin: 0 auto;
      margin-top: 20px;
      margin-bottom: 30px;
    }

    #stage {
      width: 960px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <h1>EscherSimulate</h1>
  <div id="stage"></div>
  <script src="three.min.js"></script>
  <script src="perlin-noise-simplex.js"></script>

  <script>
    Line = function() {
      this.curveObject;
    };
    Line.prototype.createLine = function() {
      var curve = new THREE.CubicBezierCurve3(
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(100, 0, 0),
        new THREE.Vector3(200, 0, 0),
        new THREE.Vector3(300, 0, 0)
      );

      this.curveObject = new THREE.Line((function() {
        var geometry = new THREE.Geometry();
        geometry.vertices = curve.getPoints(5);
        return geometry;
      })(), new THREE.LineBasicMaterial({
        color: 0xffffff
      }));

      return this.curveObject;
    };
    Line.prototype.setNoiseVal = function(val) {
      console.log(this.curveObject);
      this.curveObject.geometry.verticesNeedUpdate = true

      for (i = 0; i < this.curveObject.geometry.vertices.length; i++) {
        var vertex = this.curveObject.geometry.vertices[i];
        vertex.y = val[i];
        //vertex.y = 10;
        //vertex.x =val[i];
      }
    };
    Line.prototype.setNoiseValTest = function(val) {
      console.log(this.curveObject);
      this.curveObject.geometry.verticesNeedUpdate = true
      this.curveObject.geometry.vertices[1] = val;
      // for (i = 0; i < this.curveObject.geometry.vertices.length; i++) {
      //   var vertex = this.curveObject.geometry.vertices[i];
      //   //vertex.y = val[1];
      //   //vertex.y = 10;
      //   //vertex.x =val[i];
      // }
    };
    Line.prototype.setNoiseValTest2 = function(val) {
      console.log(this.curveObject);
      this.curveObject.geometry.verticesNeedUpdate = true

      for (i = 0; i < this.curveObject.geometry.vertices.length; i++) {
        var vertex = this.curveObject.geometry.vertices[i];
        vertex.y = val;
        //vertex.y = 10;
        //vertex.x =val[i];
      }
    };

    Rect = function() {
      this.root = new THREE.Object3D();
      this.rectWidth = 300;
      this.rectHeight = 300;
    };
    Rect.prototype.degToRad = function(deg) {
      return deg * Math.PI / 180;
    };
    Rect.prototype.createLine = function(rotationZ, translateX, translateY) {
      var simplexNoise = new SimplexNoise;
      var curve = new THREE.CubicBezierCurve3(
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(100, 0, 0),
        new THREE.Vector3(200, 0, 0),
        new THREE.Vector3(this.rectWidth, 0, 0)
      );

      var curveObject = new THREE.Line((function() {
        var geometry = new THREE.Geometry();
        geometry.vertices = curve.getPoints(5);
        return geometry;
      })(), new THREE.LineBasicMaterial({
        color: 0xffffff
      }));

      curveObject.rotation.z = this.degToRad(rotationZ);
      curveObject.translateX(translateX);
      curveObject.translateY(translateY);
      this.root.add(curveObject);
    };
    Rect.prototype.addRect = function(x, y) {
      this.createLine(0, 0, 0);
      this.createLine(-90, 0, 300);
      this.createLine(0, 0, -300);
      this.createLine(-90, 0, 0);
      this.root.translateX(x);
      this.root.translateY(y);
      this.root.scale.set(0.1, 0.1, 0.1);
      console.log(this.root);
      return this.root;
    };
    Rect.prototype.addAnimate = function(num) {
      this.root.children[0].geometry.verticesNeedUpdate = true
      var simplexNoise = new SimplexNoise;
      for (i = 0; i < this.root.children[0].geometry.vertices.length; i++) {
        var vertex = this.root.children[0].geometry.vertices[i];

        //vertex.y = simplexNoise.noise(vertex.x / 20, vertex.y / 20)*100;
        vertex.y = num[i];
      }
    };

    var syousuten2ika = function (val) {
      var val2 = 9.87654321;
      val2 *= 10;
      val2 = Math.floor(val);
      val2 /= 10;
      return val2;
    };

    (function() {
      var width = 960;
      var height = 540;
      var light;
      var camera;
      var ambient;
      var axis;
      var scene = new THREE.Scene();
      var displayObj = [];
      camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
      camera.position.set(0, 0, 800);
      camera.lookAt(new THREE.Vector3(0, 0, 0));

      light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 100, 30);
      scene.add(light);
      ambient = new THREE.AmbientLight(0x550000);
      scene.add(ambient);

      axis = new THREE.AxisHelper(1500);
      axis.position.set(0, 0, 0);
      //scene.add(axis);

      var line = new Line();
      var modelLine = line.createLine();
      scene.add(modelLine);

      var simpleNoise = new SimplexNoise;
      var date = new Date();

      var noiseArr = [];
      for (var i = 0; i < modelLine.geometry.vertices.length; i++) {

        var vertex = modelLine.geometry.vertices[i];
        //console.log(simpleNoise.noise(vertex.x / 20, vertex.y / 20) * 100);
        var randomNoise = simpleNoise.noise(vertex.x / 20, vertex.y / 20) * 100;
        noiseArr.push(syousuten2ika(randomNoise));
      }
      line.setNoiseVal(noiseArr);
      // for (var i = 0; i < 10; i++) {
      //   for (var k = 0; k < 10; k++) {
      //     var rect = new Rect();
      //     displayObj.push(rect);
      //     scene.add(rect.addRect(k * 30 - 150, i * 30 - 120));
      //   }
      // }

      var isAnimation = false;
      var isHutougou = false;
      var hikakuNuml;

      setTimeout(function () {

        var preNoise = noiseArr[1];
        noiseArr.length = 0;
        console.log("prenoise"+preNoise);
        for (var i = 0; i < modelLine.geometry.vertices.length; i++) {

          var vertex = modelLine.geometry.vertices[i];
          //console.log(simpleNoise.noise(vertex.x / 20, vertex.y / 20) * 100);
          noiseArr.push(simpleNoise.noise(vertex.x / 20, vertex.y / 20) * 100);
        }
        hikakuNum = preNoise+noiseArr[1];
        if (hikakuNum > 0 ) {
          isHutougou = true;
        }else if(hikakuNum < 0){
          isHutougou = false;
        }

        isAnimation = true;


        //line.setNoiseVal(noiseArr);
      }, 1000);

      //
      // setInterval(function() {
      //   var simplexNoise = new SimplexNoise;
      //   var num = [];
      //   for (var i = 0; i < displayObj[0].root.children[0].geometry.vertices.length; i++) {
      //     var vertex = displayObj[0].root.children[0].geometry.vertices[i];
      //     num.push(simplexNoise.noise(vertex.x / 20, vertex.y / 20) * 100);
      //   }
      //
      //
      //   for (var i = 0; i < displayObj.length; i++) {
      //     displayObj[i].addAnimate(num);
      //   }
      //   displayObj[0].addAnimate(num);
      // }, 1000);

      //rendering
      var renderer = new THREE.WebGLRenderer();
      renderer.setSize(width, height);
      renderer.setClearColor(0x000000, 1);
      document.getElementById('stage').appendChild(renderer.domElement);

      var render = function() {
        requestAnimationFrame(render);
        renderer.render(scene, camera);

        if (isAnimation) {
          modelLine.geometry.verticesNeedUpdate = true
          var vertex = modelLine.geometry.vertices[i];
          if (isHutougou) {
            console.log("hikakuNum"+hikakuNum);
            //hikakuNum = hikakuNum + 0.1;
            modelLine.geometry.vertices[1].y += 0.1;
          }else if (!isHutougou) {
            console.log("hikakuNum"+hikakuNum);
            //hikakuNum = hikakuNum - 0.1;
            //modelLine.geometry.vertices[1].y = hikakuNum;
            modelLine.geometry.vertices[1].y += 0.1;
          }
        }

      };
      render();

    })();
  </script>

</body>

</html>
